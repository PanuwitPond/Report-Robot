# üéØ ROI Editor Data Persistence Issue - Fix Plan

**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à**: 17 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2025  
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞**: üìã Ready to Review & Plan  
**‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**: üî¥ HIGH - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡πÑ‡∏õ‡∏´‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å

---

## üìç **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏£‡∏∏‡∏õ**

‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏î ROI (Intrusion Detection) ‡πÑ‡∏î‡πâ ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤ Editor ‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

---

## üîç **‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å**

### ‚úÖ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:

| ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á |
|--------|------|--------|
| **API: GET /fetch/roi/data** | ‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô | `iv-cameras.controller.ts:26-33` |
| **API: POST /save-region-config** | ‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô | `iv-cameras.controller.ts:49-102` |
| **Service: updateIvRegionConfig()** | ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | `mroi.service.ts:150-155` |
| **Data Format Transform (Load)** | ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | `RoiEditor.tsx:94-100` |
| **Database Save Logic** | ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | `iv_camera_repositorys.js:83-122` |

### ‚ö†Ô∏è **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:**

| ‡∏•‡∏≥‡∏î‡∏±‡∏ö | ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ | ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏±‡∏Å | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|-------|-------|--------|---------|----------|
| **1** | ‚ùå Data Format Mismatch (Save) | `RoiEditor.tsx:223-227` | üî¥ HIGH | ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô `{x, y}` ‡πÅ‡∏ï‡πà backend ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ `[x, y]` |
| **2** | ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Refetch ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | `RoiEditor.tsx:233` | üü† MEDIUM | ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô mroi-app-main ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `fetchROIData()` |
| **3** | ‚ö†Ô∏è Logic Merge Config ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô | `iv_camera_repositorys.js:95-103` | üü° LOW | ‡πÄ‡∏°‡∏∑‡πà‡∏≠ merge ‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ rule array ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ item |

---

## üõ†Ô∏è **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ (‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)**

### ‚ö° **‡∏õ‡∏±‡∏ç‡∏´‡∏≤ #1: Data Format Mismatch (üî¥ CRITICAL)**

#### **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
```typescript
// RoiEditor.tsx ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 223-227 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô:
points: canvasState.points  // [{x: 100, y: 200}, ...]
```

**VS** ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API:
```typescript
// RoiEditor.tsx ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 96-98 ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:
data.rule[0].points.map((p: any[]) => ({x: p[0], y: p[1]}))
// ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: [[100, 200], ...]
```

#### **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:**
- ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: `{x: 100, y: 200}` ‚Üí backend
- ‚ùå ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î: ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≠ error ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô `[NaN, NaN]` ‚Üí canvas ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤

#### **‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö backend ‡∏°‡∏µ‡∏Å‡∏≤‡∏£ validate/transform data ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
2. ‚ùì ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ RoiEditor.tsx ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô `[[x, y], ...]` format

---

### ‚ö° **‡∏õ‡∏±‡∏ç‡∏´‡∏≤ #2: ‡πÑ‡∏°‡πà‡∏°‡∏µ Refetch ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (üü† MEDIUM)**

#### **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
```typescript
// RoiEditor.tsx ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 233
navigate('/mroi');  // ‚ùå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Editor ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
// ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ fetchROIData() ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô mroi-app-main
```

**VS** mroi-app-main ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å:
```javascript
// tools_draw.jsx ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 461
fetchROIData();  // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
```

#### **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:**
- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
- ‚ö†Ô∏è ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤ data ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ DB ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- ‚ö†Ô∏è UX ‡πÑ‡∏°‡πà‡∏î‡∏µ (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ save ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà frontend success)

#### **‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
- ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `fetchIvRoiData()` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤ data ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
- ‚úÖ ‡∏ñ‡πâ‡∏≤ fetch ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞ data ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ó‡∏≥ redirect
- ‚úÖ ‡∏ñ‡πâ‡∏≤ fetch ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á alert warning

---

### ‚ö° **‡∏õ‡∏±‡∏ç‡∏´‡∏≤ #3: Data Type ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á (üü° LOW)**

#### **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
```typescript
// RoiEditor.tsx: canvasState.points = [{x: number, y: number}, ...]
// ‡∏ß‡∏≤‡∏î points ‡πÄ‡∏õ‡πá‡∏ô number type

// mroi-app-main: currentPoints = [[number, number], ...]
// ‡∏ß‡∏≤‡∏î points ‡πÄ‡∏õ‡πá‡∏ô array type
```

#### **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:**
- ‚ö†Ô∏è Type ‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á ‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ backend validation
- ‚ö†Ô∏è Database ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ `[[x, y], ...]` format ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö `{x, y}`

---

## üìã **‡πÅ‡∏ú‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î**

### **Phase 1: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Verification - 30 ‡∏ô‡∏≤‡∏ó‡∏µ)**

```
[ ] 1.1 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API response ‡∏Ç‡∏≠‡∏á save-region-config
    ‚îî‚îÄ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ rule ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô format ‡πÑ‡∏´‡∏ô
    ‚îî‚îÄ ‡πÉ‡∏ä‡πâ Browser DevTools Network tab

[ ] 1.2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Database ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    ‚îî‚îÄ Query DB ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• iv_cameras.metthier_ai_config
    ‚îî‚îÄ ‡∏î‡∏π rule array ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤

[ ] 1.3 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Format ‡∏Ç‡∏≠‡∏á points
    ‚îî‚îÄ Save: {x, y} vs [{}, {}]
    ‚îî‚îÄ Load: [[x,y], [x,y]]
```

### **Phase 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RoiEditor.tsx (High Priority)**

```
[ ] 2.1 ‡πÅ‡∏Å‡πâ handleSave() ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á points format
    ‚îî‚îÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: [{x, y}] ‚Üí [[x, y]]
    ‚îî‚îÄ ‡∏ó‡∏µ‡πà RoiEditor.tsx ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 223

[ ] 2.2 ‡πÄ‡∏û‡∏¥‡πà‡∏° Refetch ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    ‚îî‚îÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchIvRoiData() ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    ‚îî‚îÄ ‡∏ñ‡πâ‡∏≤ points ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Ñ‡πà‡∏≠‡∏¢ navigate
    ‚îî‚îÄ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‚Üí alert warning ‡πÅ‡∏™‡∏î‡∏á error

[ ] 2.3 ‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handling ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
    ‚îî‚îÄ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ alert() ‚Üí ‡πÉ‡∏ä‡πâ toast notification
    ‚îî‚îÄ ‡πÅ‡∏™‡∏î‡∏á save status ‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    ‚îî‚îÄ ‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
```

### **Phase 3: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Verification)**

```
[ ] 3.1 Test scenario: Draw ‚Üí Save ‚Üí Load
    ‚îî‚îÄ ‡∏ß‡∏≤‡∏î 4 ‡∏à‡∏∏‡∏î
    ‚îî‚îÄ ‡∏Å‡∏î Save Configuration
    ‚îî‚îÄ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Editor
    ‚îî‚îÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á

[ ] 3.2 Test data format
    ‚îî‚îÄ DevTools Network: ‡∏î‡∏π POST payload
    ‚îî‚îÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö points format [[x,y]]

[ ] 3.3 Test error recovery
    ‚îî‚îÄ Disconnect network
    ‚îî‚îÄ ‡∏Å‡∏î Save ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error
    ‚îî‚îÄ Fix network ‚Üí ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
```

---

## üîß **‡πÇ‡∏Ñ‡πâ‡∏î Changes ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥**

### **File 1: frontend/src/pages/mroi/RoiEditor.tsx**

**Location**: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 210-240

**Change 1: ‡πÅ‡∏õ‡∏•‡∏á Data Format ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å**
```typescript
// BEFORE:
points: canvasState.points,  // [{x, y}, ...]

// AFTER:
points: canvasState.points.map(p => [p.x, p.y]),  // [[x, y], ...]
```

**Change 2: ‡πÄ‡∏û‡∏¥‡πà‡∏° Refetch & Verification**
```typescript
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
const savedData = await fetchIvRoiData(customer, selectedDeviceId);
if (savedData?.rule?.[0]?.points?.length === canvasState.points.length) {
    // ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    navigate('/mroi');
} else {
    // ‚ùå ‡πÅ‡∏™‡∏î‡∏á warning
    alert('‚ö†Ô∏è Data saved but verification failed');
}
```

---

## ‚úÖ **Checklist ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**

- [ ] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏ú‡∏ô
- [ ] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏™‡∏µ‡∏¢
- [ ] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö backup ‡∏Ç‡∏≠‡∏á database ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
- [ ] ‡πÑ‡∏î‡πâ setup test environment ‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å production
- [ ] ‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rollback ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

---

## üö® **Risk Assessment**

| Risk | ‡∏•‡∏≥‡∏î‡∏±‡∏ö | Impact | Mitigation |
|------|-------|--------|-----------|
| Data format change ‡∏ó‡∏≥‡πÉ‡∏´‡πâ old data ‡πÑ‡∏°‡πà compatible | üî¥ | HIGH | ‚úÖ Backend ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 format |
| Frontend save ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß | üü† | MEDIUM | ‚úÖ Error handling + rollback |
| Performance issue ‡∏à‡∏≤‡∏Å refetch | üü° | LOW | ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° loading state + optimize |
| Redirect ‡∏Å‡πà‡∏≠‡∏ô save ‡∏à‡∏£‡∏¥‡∏á ‡πÜ | üî¥ | HIGH | ‚úÖ Verify response ‡∏Å‡πà‡∏≠‡∏ô navigate |

---

## üìä **Rollback Plan**

‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏î‡πâ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

1. **Git Revert** (‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå)
   ```bash
   git revert <commit-hash>
   ```

2. **Manual Revert** (‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)
   ```typescript
   // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ code ‡πÄ‡∏î‡∏¥‡∏°:
   points: canvasState.points  // ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà map format
   navigate('/mroi');  // ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ refetch
   ```

3. **Database Cleanup** (‡∏ñ‡πâ‡∏≤ data ‡∏´‡πâ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)
   ```sql
   UPDATE iv_cameras 
   SET metthier_ai_config = '{"rule": []}'
   WHERE iv_camera_uuid = '<device-id>';
   ```

---

## üéØ **Expected Outcome**

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à:

‚úÖ **‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**:
```
1. ‡∏ß‡∏≤‡∏î ROI (4 ‡∏à‡∏∏‡∏î)
2. ‡∏Å‡∏î Save
3. alert "‚úÖ ROI configuration saved successfully!"
4. navigate('/mroi')
5. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ Editor ‚Üí ‚ùå ‡∏à‡∏∏‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
```

‚úÖ **‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**:
```
1. ‡∏ß‡∏≤‡∏î ROI (4 ‡∏à‡∏∏‡∏î)
2. ‡∏Å‡∏î Save
3. Alert "üíæ Saving..."
4. Fetch verify data
5. alert "‚úÖ ROI saved and verified!"
6. navigate('/mroi')
7. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ Editor ‚Üí ‚úÖ ‡∏à‡∏∏‡∏î‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
```

---

## üìû **Q&A - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏à‡∏ñ‡∏≤‡∏°**

**Q: ‡∏à‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?**
A: Phase 1 (verify) 30 ‡∏ô‡∏≤‡∏ó‡∏µ + Phase 2 (fix) 45 ‡∏ô‡∏≤‡∏ó‡∏µ + Phase 3 (test) 30 ‡∏ô‡∏≤‡∏ó‡∏µ = ~2 ‡∏ä‡∏°

**Q: Data ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏´‡∏°?**
A: ‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà format ‡∏™‡πà‡∏ß‡∏ô logic save/load ‡∏¢‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏°

**Q: ‡∏ï‡πâ‡∏≠‡∏á restart service ‡πÑ‡∏´‡∏°?**
A: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏Å‡πâ Frontend ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

**Q: ‡∏ñ‡πâ‡∏≤ error ‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô?**
A: ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á alert error ‡∏û‡∏£‡πâ‡∏≠‡∏° error message ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÑ‡∏°‡πà redirect

---

**Created**: 2025-12-17  
**Status**: üìã Ready for Approval
